name: Deploy Roles Microservices to EC2

on:
  push:
    paths:
      - 'services/users/roles/**'
    branches:
      - qa

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  EC2_ROLES_HOST: ${{ secrets.EC2_ROLES_HOST }}
  EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
  EC2_KEYPAIR: ${{ secrets.EC2_KEYPAIR }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Login en Docker Hub
      - name: Login to Docker Hub
        run: |
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

      # 3Ô∏è‚É£ Build & Push de im√°genes Docker
      - name: Build & Push Docker Images
        working-directory: services/users/roles
        run: |
          services=("assign-role" "list-roles" "remove-role")
          for svc in "${services[@]}"; do
            docker build -t "$DOCKER_USERNAME/${svc}-service:latest" "./${svc}-service"
            docker push "$DOCKER_USERNAME/${svc}-service:latest"
          done

      # 4Ô∏è‚É£ Copiar docker-compose al EC2
      - name: Copy docker-compose to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_ROLES_HOST }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ env.EC2_KEYPAIR }}
          source: services/users/roles/docker-compose.roles-deploy.yml
          target: /home/ubuntu/roles-deployment/
          strip_components: 4

      # 5Ô∏è‚É£ Crear archivos .env en EC2 usando secretos
      - name: Create .env files on EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ env.EC2_ROLES_HOST }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ env.EC2_KEYPAIR }}
          script: |
            echo "üîß Generando archivos .env desde GitHub Secrets..."
            MONGO_URI="${{ secrets.ROLES_MONGO_URI }}"

            mkdir -p /home/ubuntu/roles-deployment

            declare -A PORTS=(
              [assign-role]=${{ secrets.ASSIGN_ROLE_PORT }}
              [list-roles]=${{ secrets.LIST_ROLE_PORT }}
              [remove-role]=${{ secrets.REMOVE_ROLE_PORT }}
            )

            for svc in "${!PORTS[@]}"; do
              mkdir -p "/home/ubuntu/roles-deployment/${svc}-service"
              echo "PORT=${PORTS[$svc]}" > "/home/ubuntu/roles-deployment/${svc}-service/.env"
              echo "MONGO_URI=$MONGO_URI" >> "/home/ubuntu/roles-deployment/${svc}-service/.env"
            done

            echo "‚úÖ Archivos .env generados:"
            find /home/ubuntu/roles-deployment -name .env -exec cat {} \;

      # 6Ô∏è‚É£ Desplegar los microservicios en EC2
      - name: Deploy Services via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ env.EC2_ROLES_HOST }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ env.EC2_KEYPAIR }}
          script: |
            cd /home/ubuntu/roles-deployment
            echo "‚õîÔ∏è Parando servicios anteriores si existen..."
            docker compose -f docker-compose.roles-deploy.yml down || true

            echo "‚¨áÔ∏è Haciendo pull de las √∫ltimas im√°genes..."
            docker compose -f docker-compose.roles-deploy.yml pull

            echo "üöÄ Levantando los nuevos servicios..."
            docker compose -f docker-compose.roles-deploy.yml up -d

            echo "üì¶ Contenedores activos:"
            docker ps --filter "name=role"